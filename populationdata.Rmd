---
output: html_document
---

<style>
    body .main-container {
        max-width: 100%;
        padding: 0;
        margin: 0;
    }
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r, echo=FALSE, message=F, warning=F, results = 'hide'}
library(leaflet)
library(leaflet.minicharts)
library(rgdal)
library(rvest)
library(tidyverse)
library(ggmap)
library(raster)
library(sp)
library(htmltools)
library(htmlwidgets)
library(legendreverse)
library(data.table)

round_percent <- function(x) { 
    x <- x/sum(x)*100  # Standardize result
    res <- floor(x)    # Find integer bits
    rsum <- sum(res)   # Find out how much we are missing
    if(rsum<100) { 
        # Distribute points based on remainders and a random tie breaker
        o <- order(x%%1, sample(length(x)), decreasing=TRUE) 
        res[o[1:(100-rsum)]] <- res[o[1:(100-rsum)]]+1
    } 
    res 
}

states <- readOGR("data/IndiaAdminUnits/States.shp", stringsAsFactors = FALSE)
states$ST_NM[1] <- "Andaman and Nicobar Islands"
states$ST_NM[8] <- "Dadra and Nagar Haveli"
states$ST_NM[9] <- "Daman and Diu"
states$ST_NM[14] <- "Jammu and Kashmir"
states$ST_NM[25] <- "Delhi"
states <- states[order(states$ST_NM),]
centroids <- getSpPPolygonsLabptSlots(states)
states[['Centroids']] <- centroids

url <- 'https://en.wikipedia.org/wiki/Demographics_of_India#Census_of_India:_sample_registration_system'

populationData <- url %>%
  read_html(header=TRUE, colClasses="character") %>% 
  html_nodes(xpath = '//*[@id="mw-content-text"]/div/table[9]') %>%
  html_table()
setnames(populationData[[1]], old=c("Population[52]","Rural[53]", "Urban[53]", "Area[54] (km2)", "Density (per km2)"), new=c("Population", "Rural", "Urban", "Area (sqkm)", "Density (per sqkm)"))

col2cvt <- c(1,3,5:7,9:12)

populationData[[1]][,col2cvt] <- lapply(populationData[[1]][,col2cvt],function(x){as.numeric(gsub(",", "", x))})

populationData[[1]] <- populationData[[1]][-37,]
populationData[[1]]["Urban Rural Ratio"] <- format(signif(as.numeric(populationData[[1]]$`Urban`/populationData[[1]]$`Rural`), 4))
populationData[[1]]["Urban Percentage"] <-
format(signif(as.numeric(100.0*populationData[[1]]$`Urban`/populationData[[1]]$`Population`), 4))
populationData[[1]]["Rural Percentage"] <-
format(signif(as.numeric(100.0*populationData[[1]]$`Rural`/populationData[[1]]$`Population`), 4))

populationData[[1]] <- populationData[[1]][order(populationData[[1]]$`State/UT`),]

states@data <- cbind(states@data,  populationData[[1]][,3:15])

plotSubsetPop <- subset(states, states$`Population` > 350000)
plotSubsetPopDens <- subset(states, states$`Area (sqkm)` > 1500)
plotSubsetGR <- subset(states, states$`Area (sqkm)` > 1500)
plotSubsetUR <- subset(states, states$`Area (sqkm)` > 1500)

```

## {.tabset}
### Statewise, Population Density*

```{r, echo=FALSE, warning=F}
labsPD <- lapply(seq(nrow(states@data)), function(i) {
  paste0( '<p>', sprintf(
        "<div style='width:95%%'>
        <div style='font-size:12px;width:200px;float:left'>
        <span style='font-size:12px;font-weight:bold'>%s</span><hr>
        <span style='float:left'>Population : %s (%s%%)</span><br/>
        <span style='background:#fe6a59;width:%s%%;float:left'>&nbsp;</span>
        <span style='background:#eeeeee;width:%s%%;float:right'>&nbsp;</span><hr>
        <span style='float:left'>Area (sqkm): %s (%s%%)</span><br/>
        <span style='background:#fe6a59;width:%s%%;float:left'>&nbsp;</span>
        <span style='background:#eeeeee;width:%s%%;float:right'>&nbsp;</span><hr>
        <span style='float:left'>Population Density: %s per sqkm</span>
        </div>
        </div>",
        states@data[i, "ST_NM"],
        format(as.numeric(states@data[i, "Population"]), big.mark=","),
        as.numeric(states@data[i, "Percent (%)"]), 
        as.numeric(states@data[i, "Percent (%)"]), 100.0 - as.numeric(states@data[i, "Percent (%)"]),
        format(as.numeric(states@data[i, "Area (sqkm)"]), big.mark=","), 
        format(round(100.0*as.numeric(states@data[i, "Area (sqkm)"])/3287240,2)),
        100.0*as.numeric(states@data[i, "Area (sqkm)"])/3287240, 100.0 - 100.0*as.numeric(states@data[i, "Area (sqkm)"])/3287240,
        states@data[i, "Density (per sqkm)"]
      ), '</p>' ) 
})

palpopdens <- colorNumeric(
  palette = "YlOrRd",
  domain = plotSubsetPopDens$`Density (per sqkm)`
)

map <- leaflet(width = "100%") %>% 
  addProviderTiles("Esri") %>% 
  addPolygons(data = states,
              color = "#000000", 
              weight = 1, smoothFactor = 0.5,
              opacity = 1.0, fillOpacity = 0.8,
              dashArray = "3",
              fillColor = ~palpopdens(states$`Density (per sqkm)`),
              label = lapply(labsPD, htmltools::HTML),
              labelOptions = labelOptions(
                offset=c(-100,-140),
                textOnly = T,
                style=list(
                  'background'='rgba(255,255,255,0.95)',
                  'border-color' = 'rgba(0,0,0,1)',
                  'border-radius' = '10px',
                  'border-style' = 'solid',
                  'border-width' = '2px')),
              highlightOptions = highlightOptions(color = "white", weight = 2),
              group = "Population Density") %>%
  
  addMiniMap(tiles = providers$Esri, toggleDisplay = TRUE) %>% 
  addScaleBar() %>%
  addSimpleGraticule(showOriginLabel = TRUE) %>%
  addLegend("bottomleft", pal = palpopdens, values = plotSubsetPopDens$`Density (per sqkm)`, title = "Population Density", opacity = 1, group = "Population Density", layerId = "Population Density" )
  
map
  
```

### Statewise, Gender Ratio*

```{r, echo=FALSE, warning=F}

labsGR <- lapply(seq(nrow(states@data)), function(i) {
  nums <- round_percent(c(as.numeric(100*states@data[i, "Male"]/states@data[i, "Population"]),as.numeric(100*states@data[i, "Female"]/states@data[i, "Population"])))
  paste0( '<p>', sprintf(
        "<div style='font-size:12px;width:200px;float:left'>
        <span style='font-size:12px;font-weight:bold'>%s</span><hr>
        Gender Ratio: %s<br/>
        <div style='width:95%%'>
        <span style='float:left'>Males</span>
        <span style='float:right'>Females</span>
        <br/>
        <span style='color:#2aa1ec;float:left'>%s%%</span>
        <span style='color:#fe6a59;float:right'>%s%%</span><br clear='all'/>
        <span style='background:#2aa1ec;width:%s%%;float:left'>&nbsp;</span>
        <span style='background:#fe6a59;width:%s%%;float:right'>&nbsp;</span><hr>
        <span style='float:left'>Males: </span>
        <span style='float:right'>%s</span><br/>
        <span style='float:left'>Females: </span>
        <span style='float:right'>%s</span><br/>
        <span style='float:left'>Difference: </span>
        <span style='float:right'>%s</span>
        </div>
        </div>",
        states@data[i, "ST_NM"],
        states@data[i, "Sex ratio"],
        nums[1], nums[2],
        nums[1], nums[2],
        format(states@data[i, "Male"], big.mark=","), format(states@data[i, "Female"], big.mark=","), format(states@data[i, "Difference between male and female"], big.mark=",")
      ), '</p>' ) 
})

palpopgr <- colorNumeric(
  palette = "YlOrRd",
  reverse = TRUE,
  domain = plotSubsetGR$`Sex ratio`
)

mapGR <- leaflet(width = "100%") %>%
  addProviderTiles("Esri") %>% 
  addPolygons(
    data = states,
    color = "#000000", 
    weight = 1, smoothFactor = 0.5,
    opacity = 1.0, fillOpacity = 0.8,
    dashArray = "3",
    fillColor = ~palpopgr(as.numeric(states$`Sex ratio`)),
    label = lapply(labsGR, htmltools::HTML),
    labelOptions = labelOptions(
      offset=c(-100,-140),
      textOnly = T,
      style=list(
        'background'='rgba(255,255,255,0.95)',
        'border-color' = 'rgba(0,0,0,1)',
        'border-radius' = '10px',
        'border-style' = 'solid',
        'border-width' = '2px')),
    highlightOptions = highlightOptions(color = "white", weight = 2),
              group = "Gender Ratio") %>%
  
  addMiniMap(tiles = providers$Esri, toggleDisplay = TRUE) %>% 
  addScaleBar() %>%
  addSimpleGraticule(showOriginLabel = TRUE) %>%
  legendreverse("bottomleft", pal = palpopgr, values = plotSubsetGR$`Sex ratio`, opacity = 1, decreasing = TRUE, title = "Gender Ratio", group = "Gender Ratio", layerId = "Gender Ratio" )
  
mapGR
  
```

### Statewise, Urban:Rural Ratio*

```{r, echo=FALSE, warning=F}
# This is our pretty hover content
labs <- lapply(seq(nrow(states@data)), function(i) {
  nums <- round_percent(c(as.numeric(states@data[i, "Urban Percentage"]),as.numeric(states@data[i, "Rural Percentage"])))
  paste0( '<p>', sprintf(
        "<div style='font-size:12px;width:200px;float:left'>
        <span style='font-size:12px;font-weight:bold'>%s</span><br/><hr>
        Urban:Rural Ratio: %s<br/>
        <div style='width:95%%'>
        <span style='float:left'>Urban</span>
        <span style='float:right'>Rural</span>
        <br/>
        <span style='color:#2aa1ec;float:left'>%s%%</span>
        <span style='color:#fe6a59;float:right'>%s%%</span><br clear='all'/>
        <span style='background:#2aa1ec;width:%s%%;float:left'>&nbsp;</span>
        <span style='background:#fe6a59;width:%s%%;float:right'>&nbsp;</span><hr>
        <span style='float:left'>Urban Population: </span>
        <span style='float:right'>%s</span><br/>
        <span style='float:left'>Rural Population: </span>
        <span style='float:right'>%s</span><br/>
        <span style='float:left'>Total Population: </span>
        <span style='float:right'>%s</span>
        </div>
        </div>",
        states@data[i, "ST_NM"],
        states@data[i, "Urban Rural Ratio"],
        nums[1],nums[2],
        nums[1],nums[2],
        format(states@data[i, "Urban"], big.mark=","), format(states@data[i, "Rural"], big.mark=","), format(states@data[i, "Population"], big.mark=",")
      ), '</p>' ) 
})

palpopur <- colorNumeric(
  palette = "YlOrRd",
  reverse = T,
  domain = as.numeric(plotSubsetUR@data$`Urban Rural Ratio`)
)

mapUR <- leaflet(width = "100%") %>%
  addProviderTiles("Esri") %>% 
  addPolygons(
    data = states,
    color = "#000000", 
    weight = 1, smoothFactor = 0.5,
    opacity = 1.0, fillOpacity = 0.8,
    dashArray = "3",
    fillColor = ~palpopur(as.numeric(states$`Urban Rural Ratio`)),
    label = lapply(labs, htmltools::HTML),
    labelOptions = labelOptions(
      offset=c(-100,-140),
      textOnly = T,
      style=list(
        'background'='rgba(255,255,255,0.95)',
        'border-color' = 'rgba(0,0,0,1)',
        'border-radius' = '4px',
        'border-style' = 'solid',
        'border-width' = '4px')),
    highlightOptions = highlightOptions(color = "white", weight = 2),
              group = "Urban:Rural") %>%
  
  addMiniMap(tiles = providers$Esri, toggleDisplay = TRUE) %>% 
  addScaleBar() %>%
  addSimpleGraticule(showOriginLabel = TRUE) %>%
  legendreverse("bottomleft", pal = palpopur, values = as.numeric(plotSubsetUR$`Urban Rural Ratio`), decreasing = T, opacity = 1, title = "Urban:Rural", group = "Urban:Rural", layerId = "Urban:Rural" )
  
mapUR

```

### Data

```{r}
library(DT)
populationData[[1]] <- populationData[[1]][order(populationData[[1]]$Rank),]
populationData[[1]][,col2cvt] <- lapply(populationData[[1]][,col2cvt],function(x){format(round(as.numeric(x), 2), big.mark=",")})
datatable(populationData[[1]], options = list(pageLength = 36), rownames = FALSE)
```

Source: https://en.wikipedia.org/wiki/Demographics_of_India#Census_of_India:_sample_registration_system

### Info

Shape files from:
Demo of 4 colour theorem

## 
*2011 Census
Source: https://en.wikipedia.org/wiki/Demographics_of_India#Census_of_India:_sample_registration_system